name: Update Logs (Multi-Service + Project)

on:
  pull_request:
    types: [closed]

jobs:
  update_logs:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      ###########################################################
      # Get changed files safely
      ###########################################################
      - name: Get PR changed files
        id: changes
        uses: tj-actions/changed-files@v41

      ###########################################################
      # Extract PR info
      ###########################################################
      - name: Extract PR info
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "DATE=$(date +"%Y-%m-%d")" >> $GITHUB_ENV

      ###########################################################
      # Category classification
      ###########################################################
      - name: Classify category
        run: |
          TITLE="${{ github.event.pull_request.title }}"

          if [[ "$TITLE" == feat:* ]]; then
            echo "CATEGORY=### âœ¨ Features" >> $GITHUB_ENV
            echo "BUMP=minor" >> $GITHUB_ENV
          elif [[ "$TITLE" == fix:* ]]; then
            echo "CATEGORY=### ðŸž Fixes" >> $GITHUB_ENV
            echo "BUMP=patch" >> $GITHUB_ENV
          elif [[ "$TITLE" == docs:* ]]; then
            echo "CATEGORY=### ðŸ“š Docs" >> $GITHUB_ENV
            echo "BUMP=patch" >> $GITHUB_ENV
          elif [[ "$TITLE" == refactor:* ]]; then
            echo "CATEGORY=### ðŸ›  Refactor" >> $GITHUB_ENV
            echo "BUMP=patch" >> $GITHUB_ENV
          elif [[ "$TITLE" == chore:* ]]; then
            echo "CATEGORY=### â™»ï¸ Chore" >> $GITHUB_ENV
            echo "BUMP=patch" >> $GITHUB_ENV
          else
            echo "CATEGORY=### ðŸ”§ Misc" >> $GITHUB_ENV
            echo "BUMP=patch" >> $GITHUB_ENV
          fi

      ###########################################################
      # Detect changed services under lib/<service>/
      ###########################################################
      - name: Detect affected services
        run: |
          SERVICES=""
          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$file" == lib/*/* ]]; then
              SERVICE=$(echo $file | cut -d'/' -f2)
              SERVICES="$SERVICES $SERVICE"
            fi
          done

          UNIQUE_SERVICES=$(printf "%s\n" $SERVICES | sort -u)
          echo "SERVICES=$UNIQUE_SERVICES" >> $GITHUB_ENV

      ###########################################################
      # Detect project-level changes (everything outside lib/)
      ###########################################################
      - name: Detect project-level changes
        run: |
          PROJECT_CHANGED=""
          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$file" != lib/* ]]; then
              PROJECT_CHANGED="yes"
              break
            fi
          done
          echo "PROJECT_CHANGED=$PROJECT_CHANGED" >> $GITHUB_ENV

      ###########################################################
      # Update project_log.md if project-level files changed
      ###########################################################
      - name: Update project_log.md
        if: env.PROJECT_CHANGED == 'yes'
        run: |
          echo "## ${{ env.DATE }}" > new_project.md
          echo "${{ env.CATEGORY }}" >> new_project.md
          echo "- **${{ env.PR_TITLE }}** (#${{ env.PR_NUMBER }}) by @${{ env.AUTHOR }}" >> new_project.md
          echo "" >> new_project.md
          echo "### ðŸ”§ Changed files" >> new_project.md
          for f in ${{ steps.changes.outputs.all_changed_files }}; do
            echo "- $f" >> new_project.md
          done
          echo "" >> new_project.md
          echo "---" >> new_project.md

          if [ -f "project_log.md" ]; then   
            cat project_log.md >> new_project.md
          fi

          mv new_project.md project_log.md

      ###########################################################
      # Update service-level CHANGELOG and VERSION
      ###########################################################
      - name: Update service logs
        if: env.SERVICES != ''
        run: |
          IFS=' ' read -ra SERVICE_LIST <<< "${{ env.SERVICES }}"

          for SERVICE in "${SERVICE_LIST[@]}"; do

            VERSION_FILE="lib/$SERVICE/VERSION"
            CHANGELOG_FILE="lib/$SERVICE/CHANGELOG.md"

            # Create version file if missing
            if [ ! -f "$VERSION_FILE" ]; then
              echo "0.1.0" > "$VERSION_FILE"
            fi

            VERSION=$(cat "$VERSION_FILE")
            MAJOR=$(echo "$VERSION" | cut -d. -f1)
            MINOR=$(echo "$VERSION" | cut -d. -f2)
            PATCH=$(echo "$VERSION" | cut -d. -f3)

            if [[ "${{ env.BUMP }}" == "minor" ]]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "$NEW_VERSION" > "$VERSION_FILE"

            # Update service changelog
            echo "## v${NEW_VERSION} - ${{ env.DATE }}" > new.md
            echo "${{ env.CATEGORY }}" >> new.md
            echo "- **${{ env.PR_TITLE }}** (#${{ env.PR_NUMBER }}) by @${{ env.AUTHOR }}" >> new.md
            echo "" >> new.md

            if [[ ! -z "${{ env.PR_BODY }}" ]]; then
              echo "> ${{ env.PR_BODY }}" >> new.md
              echo "" >> new.md
            fi

            echo "---" >> new.md
            echo "" >> new.md

            if [ -f "$CHANGELOG_FILE" ]; then
              cat "$CHANGELOG_FILE" >> new.md
            fi

            mv new.md "$CHANGELOG_FILE"

          done

      ###########################################################
      # Commit all changes
      ###########################################################
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add project_log.md
          git add lib/*/CHANGELOG.md
          git add lib/*/VERSION
          git commit -m "Auto-update logs (PR #${{ env.PR_NUMBER }})" || echo "No changes to commit"
          git push || echo "Nothing to push"
