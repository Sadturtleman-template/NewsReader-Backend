name: Update Logs & Changelogs

on:
  pull_request:
    types: [closed]

jobs:
  update-logs:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      ###########################################################
      # Get all changed files (safest)
      ###########################################################
      - name: Get PR changed files
        id: changes
        uses: tj-actions/changed-files@v41

      ###########################################################
      # Detect modified services under lib/<service>/*
      ###########################################################
      - name: Detect modified services
        id: detect
        run: |
          SERVICES=""
          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$file" == lib/*/* ]]; then
              SERVICE=$(echo "$file" | cut -d'/' -f2)
              SERVICES="$SERVICES $SERVICE"
            fi
          done

          UNIQUE=$(printf "%s\n" $SERVICES | sort -u)
          echo "SERVICES=$UNIQUE" >> $GITHUB_ENV

      ###########################################################
      # Extract PR Information
      ###########################################################
      - name: Extract PR info
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "FILES='${{ steps.changes.outputs.all_changed_files }}'" >> $GITHUB_ENV

      ###########################################################
      # Determine PR Category
      ###########################################################
      - name: Determine PR category
        run: |
          TITLE="${{ env.PR_TITLE }}"

          if [[ "$TITLE" == feat:* ]]; then
            echo "CATEGORY=### âœ¨ Features" >> $GITHUB_ENV
            echo "VERSION_BUMP=minor" >> $GITHUB_ENV
          elif [[ "$TITLE" == fix:* ]]; then
            echo "CATEGORY=### ðŸž Fixes" >> $GITHUB_ENV
            echo "VERSION_BUMP=patch" >> $GITHUB_ENV
          elif [[ "$TITLE" == docs:* ]]; then
            echo "CATEGORY=### ðŸ“š Docs" >> $GITHUB_ENV
            echo "VERSION_BUMP=patch" >> $GITHUB_ENV
          elif [[ "$TITLE" == refactor:* ]]; then
            echo "CATEGORY=### ðŸ›  Refactor" >> $GITHUB_ENV
            echo "VERSION_BUMP=patch" >> $GITHUB_ENV
          elif [[ "$TITLE" == chore:* ]]; then
            echo "CATEGORY=### â™»ï¸ Chore" >> $GITHUB_ENV
            echo "VERSION_BUMP=patch" >> $GITHUB_ENV
          else
            echo "CATEGORY=### ðŸ”§ Misc" >> $GITHUB_ENV
            echo "VERSION_BUMP=patch" >> $GITHUB_ENV
          fi

      ###########################################################
      # Update project-level project_log.md ALWAYS
      ###########################################################
      - name: Update project-level log
        run: |
          TARGET="project_log.md"

          echo "## ${{ env.DATE }} - PR #${{ env.PR_NUMBER }}" > new_log.md
          echo "${{ env.CATEGORY }}" >> new_log.md
          echo "- **${{ env.PR_TITLE }}** by @${{ env.AUTHOR }}" >> new_log.md
          echo "" >> new_log.md

          if [[ ! -z "${{ env.PR_BODY }}" ]]; then
            echo "> ${{ env.PR_BODY }}" >> new_log.md
            echo "" >> new_log.md
          fi

          echo "#### ðŸ—‚ Changed Files" >> new_log.md
          for f in ${{ env.FILES }}; do
            echo "- \`$f\`" >> new_log.md
          done

          echo "" >> new_log.md
          echo "---" >> new_log.md
          echo "" >> new_log.md

          if [ -f "$TARGET" ]; then
            cat "$TARGET" >> new_log.md
          fi

          mv new_log.md "$TARGET"

      ###########################################################
      # If services changed â†’ update each service
      ###########################################################
      - name: Update affected services
        if: ${{ env.SERVICES != '' }}
        run: |
          IFS=' ' read -ra SERVICE_LIST <<< "${{ env.SERVICES }}"

          for SERVICE in "${SERVICE_LIST[@]}"; do
            echo "Processing $SERVICE ..."

            VERSION_FILE="lib/$SERVICE/VERSION"
            CHANGELOG="lib/$SERVICE/CHANGELOG.md"

            # init version if missing
            if [ ! -f "$VERSION_FILE" ]; then
              echo "0.1.0" > "$VERSION_FILE"
            fi

            VERSION=$(cat "$VERSION_FILE")
            MAJOR=$(echo "$VERSION" | cut -d. -f1)
            MINOR=$(echo "$VERSION" | cut -d. -f2)
            PATCH=$(echo "$VERSION" | cut -d. -f3)

            if [[ "${{ env.VERSION_BUMP }}" == "minor" ]]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "$NEW_VERSION" > "$VERSION_FILE"

            # Write service changelog
            echo "## v$NEW_VERSION - ${{ env.DATE }}" > new_cl.md
            echo "${{ env.CATEGORY }}" >> new_cl.md
            echo "- **${{ env.PR_TITLE }}** (#${{ env.PR_NUMBER }}) by @${{ env.AUTHOR }}" >> new_cl.md
            echo "" >> new_cl.md

            if [[ ! -z "${{ env.PR_BODY }}" ]]; then
              echo "> ${{ env.PR_BODY }}" >> new_cl.md
              echo "" >> new_cl.md
            fi

            echo "#### ðŸ—‚ Changed Files" >> new_cl.md
            for f in ${{ env.FILES }}; do
              if [[ "$f" == "lib/$SERVICE/"* ]]; then
                echo "- \`$f\`" >> new_cl.md
              fi
            done

            echo "" >> new_cl.md
            echo "---" >> new_cl.md
            echo "" >> new_cl.md

            if [ -f "$CHANGELOG" ]; then
              cat "$CHANGELOG" >> new_cl.md
            fi

            mv new_cl.md "$CHANGELOG"
          done

      ###########################################################
      # Commit & Push
      ###########################################################
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add project_log.md
          git add lib/*/VERSION
          git add lib/*/CHANGELOG.md
          git commit -m "Update logs & changelogs (PR #${{ env.PR_NUMBER }})" || echo "No changes"
          git push || echo "Nothing to push"
