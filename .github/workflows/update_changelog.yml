name: Update Multi-Service Changelog & Version

on:
  pull_request:
    types: [closed]

jobs:
  changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      ###########################################################
      # Get all changed files with tj-actions (safest way)
      ###########################################################
      - name: Get PR changed files
        id: changes
        uses: tj-actions/changed-files@v41

      ###########################################################
      # Detect modified services under lib/<service>/*
      ###########################################################
      - name: Detect modified services
        id: detect
        run: |
          SERVICES=""
          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$file" == lib/*/* ]]; then
              SERVICE=$(echo $file | cut -d'/' -f2)
              SERVICES="$SERVICES $SERVICE"
            fi
          done

          # Export unique services
          UNIQUE=$(printf "%s\n" $SERVICES | sort -u)
          echo "SERVICES=$UNIQUE" >> $GITHUB_ENV

      - name: Print detected services
        run: |
          echo "Changed services: ${{ env.SERVICES }}"

      - name: Skip if no services changed
        if: ${{ env.SERVICES == '' }}
        run: echo "No services modified; skipping workflow."

      ###########################################################
      # Extract PR Information
      ###########################################################
      - name: Extract PR info
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "DATE=$(date +"%Y-%m-%d")" >> $GITHUB_ENV

      ###########################################################
      # Process all changed services
      ###########################################################
      - name: Update each service
        run: |
          IFS=' ' read -ra SERVICE_LIST <<< "${{ env.SERVICES }}"

          for SERVICE in "${SERVICE_LIST[@]}"; do
            echo "Processing $SERVICE ..."
            VERSION_FILE="lib/$SERVICE/VERSION"
            CHANGELOG_FILE="lib/$SERVICE/CHANGELOG.md"

            ######################################################
            # Determine CHANGELOG category & bump type
            ######################################################
            TITLE="${{ env.PR_TITLE }}"
            if [[ $TITLE == feat:* ]]; then
              CATEGORY="### âœ¨ Features"
              BUMP="minor"
            elif [[ $TITLE == fix:* ]]; then
              CATEGORY="### ðŸž Fixes"
              BUMP="patch"
            elif [[ $TITLE == docs:* ]]; then
              CATEGORY="### ðŸ“š Docs"
              BUMP="patch"
            elif [[ $TITLE == refactor:* ]]; then
              CATEGORY="### ðŸ›  Refactor"
              BUMP="patch"
            elif [[ $TITLE == chore:* ]]; then
              CATEGORY="### â™»ï¸ Chore"
              BUMP="patch"
            else
              CATEGORY="### ðŸ”§ Misc"
              BUMP="patch"
            fi

            ######################################################
            # Read VERSION file & bump version
            ######################################################
            if [ ! -f "$VERSION_FILE" ]; then
              echo "0.1.0" > "$VERSION_FILE"
            fi

            VERSION=$(cat $VERSION_FILE)
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)

            if [[ "$BUMP" == "minor" ]]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "$NEW_VERSION" > "$VERSION_FILE"

            ######################################################
            # Update CHANGELOG file
            ######################################################
            echo "## v$NEW_VERSION - ${{ env.DATE }}" > new.md
            echo "$CATEGORY" >> new.md
            echo "- **${{ env.PR_TITLE }}** (#${{ env.PR_NUMBER }}) by @${{ env.AUTHOR }}" >> new.md
            echo "" >> new.md

            if [[ ! -z "${{ env.PR_BODY }}" ]]; then
              echo "> ${{ env.PR_BODY }}" >> new.md
              echo "" >> new.md
            fi

            echo "---" >> new.md
            echo "" >> new.md

            if [ -f "$CHANGELOG_FILE" ]; then
              cat "$CHANGELOG_FILE" >> new.md
            fi

            mv new.md "$CHANGELOG_FILE"

          done

      ###########################################################
      # Commit & Push
      ###########################################################
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config.user.email "github-actions[bot]@users.noreply.github.com"
          git add lib/*/VERSION
          git add lib/*/CHANGELOG.md
          git commit -m "Auto-update versions & changelogs for services (PR #${{ env.PR_NUMBER }})"
          git push
